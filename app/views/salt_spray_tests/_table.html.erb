<%= form_with url: salt_spray_tests_path, class: 'filter-form bg-warning hidden-print', method: 'get' do |f| %>
  <div class="row">
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_shop_order_number, 'Shop Order:'  %>
        <%= f.text_field :with_shop_order_number, class: 'form-control', value: params[:with_shop_order_number] %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_put_on_by, 'Put On By:'  %>
        <%= f.select :with_put_on_by, @salt_spray_tests.options_for_put_on_by, { include_blank: true, selected: params[:with_put_on_by] }, { class: 'form-control' } %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_customer, 'Customer:'  %>
        <%= f.select :with_customer, @salt_spray_tests.options_for_customer, { include_blank: true, selected: params[:with_customer] }, { class: 'form-control' } %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_part_number, 'Part ID:'  %>
        <%# if params[:with_part_number].blank? %>
          <%= f.select :with_part_number, @salt_spray_tests.options_for_part_number, { include_blank: true, selected: params[:with_part_number] }, { class: 'form-control' } %>
        <%# else %>
          <%#= f.select :with_part_number, SaltSprayTest.options_for_part_number, { include_blank: true, selected: params[:with_part_number] }, { class: 'form-control' } %>
        <%# end %>
      </div>
    </div>
    <div class="col-md-1">
      <div class="form-group">
        <%= f.label :with_process_code, 'Process:'  %>
        <%= f.select :with_process_code, @salt_spray_tests.options_for_process_code, {include_blank: true, selected: params[:with_process_code]}, { class: 'form-control' } %>
      </div>
    </div>
    <div class="col-md-1">
      <div class="form-group">
        <%= f.label :with_sample, 'Is Sample:'  %>
        <%= f.check_box :with_sample, class: 'form-control', checked: params[:with_sample] == '1' ? true : false %>
      </div>
    </div>
    <div class="col-md-1">
      <div class="form-group">
        <%= f.label :with_has_comments, 'Has Comments:'  %>
        <%= f.check_box :with_has_comments, class: 'form-control', checked: params[:with_has_comments] == '1' ? true : false %>
      </div>
    </div>
    <div class="col-md-1">
      <div class="form-group">
        <%= f.label :with_has_attachments, 'Has Attachments:'  %>
        <%= f.check_box :with_has_attachments, class: 'form-control', checked: params[:with_has_attachments] == '1' ? true : false %>
      </div>
    </div>
    <div class="col-md-4">
      <div class="form-group">
        <%= f.label :with_comments, 'Search Comments:'  %>
        <%= f.text_field :with_comments, class: 'form-control', value: params[:with_comments] %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_sub, 'Sub ID:'  %>
        <%= f.text_field :with_sub, class: 'form-control', value: params[:with_sub] %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_put_on_at_gte, 'Date On - Start:' %>
        <%= f.date_field :with_put_on_at_gte, class: 'form-control', value: params[:with_put_on_at_gte] %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :with_put_on_at_lte, 'Date On - End:' %>
        <%= f.date_field :with_put_on_at_lte, class: 'form-control', value: params[:with_put_on_at_lte] %>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group">
        <%= f.label :sorted_by, 'Sorted By:' %>
        <%= f.select :sorted_by, @salt_spray_tests.options_for_sorted_by, { selected: params[:sorted_by] }, { class: 'form-control' } %>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <%= link_to 'Reset Filters', salt_spray_tests_url, class: 'btn btn-sm btn-link float-left' %>
      <%= f.submit 'Filter', name: nil, class: 'float-right' %>
    </div>
  </div>
<% end %>

<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr class="row m-0">
        <th class="col-1 text-center">Shop Order </th>
        <th class="col-1 text-center">Part ID</th>
        <th class="col-1 text-center">Proc.</th>
        <th class="col-2">Date On</th>
        <% if action_name == 'archived_tests' %>
          <th class="col-2">Date Off</th>
        <% end %>
        <th class="col-2">White Rust</th> <!-- marked_white_at, marked_white_by -->
        <th class="col-2">Red Rust</th> <!-- marked_red_at, marked_red_by -->
        <th class="col-<%= action_name == 'archived_tests' ? 1 : 2 %>">Comments</th>
        <th class="col-1 text-center hidden-print <%= ' d-none' if action_name == 'archived_tests' %>"></th>
      </tr>
    </thead>
    <tbody>
      <% @salt_spray_tests.each do |t| -%>
        <tr class="row m-0">
          <td class="col-1 text-center shop-order">
            <%= link_to t.shop_order_number, salt_spray_test_path(t), remote: true %><br />
            <small>Load: <%= t.load_number %></small><br />
            <% if t.dept %><small>Dept: <%= t.dept %></small><% end %>
          </td>
          <td class="col-1 text-center prevent-text-overflow"><%= t.part_number %></td>
          <td class="col-1 text-center process"><%= t.process_code %></td>
          <td class="col-2">
            <%= t.put_on_at.strftime('%m/%d/%Y') %><br />
            <small><strong>By: </strong></small><%= t.salt_spray_tester.full_name %><br />
            <small><strong>Hours On: </strong></small><%= t.calculate_rust_hours(t.pulled_off_at) %>
          </td>
          <% if t.pulled_off_at.present? %>
            <td class="col-2">
              <%= t.pulled_off_at.strftime('%m/%d/%Y') %><br />
              <small><strong>By: </strong></small><%= t.test_completed_by.full_name %>
            </td>
          <% end %>
          <td class="col-2">
            <% if t.marked_white? %>
              <%= t.marked_white_at.strftime('%m/%d/%Y') %><br />
              <small><strong>By: </strong></small><%= t.white_spot_reporter.full_name %><br />
              <small><strong>Hours w/o: </strong></small><%= t.calculate_rust_hours(t.marked_white_at) %>
            <% end %>
          </td>
          <td class="col-2">
            <% if t.marked_red? %>
              <%= t.marked_red_at.strftime('%m/%d/%Y') %><br />
              <small><strong>By: </strong></small><%= t.red_spot_reporter.full_name %><br />
              <small><strong>Hours w/o: </strong></small><%= t.calculate_rust_hours(t.marked_red_at) %>
            <% end %>
          </td>
          <td class="col-<%= action_name == 'archived_tests' ? 1 : 2 %>">
            <%= link_to "View Comments", show_comments_salt_spray_test_path(t.id), remote: true, class: 'btn btn-sm btn-link pl-0' if has_comments(t) %>
            <% if action_name != 'archived_tests' %>
              <% if has_attachments(t) %>
                | <%= link_to "View Attachments", salt_spray_test_path(t.id, has_attachment: true), remote: true, class: 'btn btn-sm btn-link' %>
              <% end %>
              <%= link_to 'Add Comment/Attachments', add_comment_salt_spray_test_path(t), class: 'btn btn-sm btn-success' %>
            <% else %>
              <% if has_attachments(t) %>
                <br /><%= link_to "View Attachments", salt_spray_test_path(t.id, has_attachment: true), remote: true, class: 'btn btn-sm btn-link pl-0' %>
              <% end %>
            <% end %>
          </td>
          <% if @access_level.access_level == 3 and action_name != 'archived_tests' -%>
            <td class="col-md-1 text-center hidden-print">
              <a href="#" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Actions</a>
              <div class="dropdown-menu text-center">
                  <%= link_to 'Edit', edit_salt_spray_test_path(t), class: "dropdown-item text-info" %>
                  <% if !t.marked_white_at %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :marked_white_at, value: Date.current %>
                      <%= f.hidden_field :marked_white_by, value: current_user.id %>
                      <%= f.submit 'Mark White', class: 'btn-form dropdown-item' %>
                    <% end %>
                  <% end %>
                  <% if !t.marked_red_at %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :marked_red_at, value: Date.current %>
                      <%= f.hidden_field :marked_red_by, value: current_user.id %>
                      <%= f.submit 'Mark Red', class: 'btn-form dropdown-item' %>
                    <% end %>
                  <% end %>
                  <% if t.marked_red_at || t.marked_white_at %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :pulled_off_at, value: Date.current %>
                      <%= f.hidden_field :pulled_off_by, value: current_user.id %>
                      <%= f.submit 'Mark Complete', class: 'btn-form dropdown-item', data: {confirm: t.ready_to_archive? ? nil : 'Are you sure?'} %>
                    <% end %>
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <%= link_to 'Delete', salt_spray_test_path(t), data: { confirm: 'Are you sure?'}, method: 'delete', class: 'text-danger dropdown-item' %>
              </div><br>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
