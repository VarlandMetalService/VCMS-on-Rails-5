<div class="filter-form border-0 mb-0 p-0">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="standard-tab" data-toggle="tab" href="#standard" role="tab" aria-controls="home" aria-selected="true">Standard</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="dates-tab" data-toggle="tab" href="#dates" role="tab" aria-controls="dates" aria-selected="false">Dates</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="process-steps-tab" data-toggle="tab" href="#process-steps" role="tab" aria-controls="process-steps" aria-selected="false">Process Steps</a>
    </li>
  </ul>
  <%= form_with url: filter_path, class: 'filter-form bg-warning hidden-print border-top-0', method: 'get', local: true do |f| %>

    <div class="tab-content mt-2" id="myTabContent">
      <div class="row tab-pane fade show active" id="standard" role="tabpanel" aria-labelledby="standard-tab">
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_shop_order_number, 'Shop Order:'  %>
            <%= f.text_field :with_shop_order_number, class: 'form-control', value: params[:with_shop_order_number] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_customer, 'Customer:'  %>
            <%= f.select :with_customer, @salt_spray_tests.options_for_customer, { include_blank: true, selected: params[:with_customer] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <%= f.label :with_sub, 'Sub ID:'  %>
            <%= f.text_field :with_sub, class: 'form-control', value: params[:with_sub] %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group">
            <%= f.label :with_process_code, 'Process:'  %>
            <%= f.select :with_process_code, SaltSprayTest.options_for_process_code, {include_blank: true, selected: params[:with_process_code]}, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_part_number, 'Part ID:'  %>
              <%= f.select :with_part_number, @salt_spray_tests.options_for_part_number, { include_blank: true, selected: params[:with_part_number] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :sorted_by, 'Sorted By:' %>
            <%= f.select :sorted_by, sorted_by_options, { selected: params[:sorted_by] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group text-center">
            <%= f.label :with_flag, 'Is Flagged:'  %>
            <%= f.check_box :with_flag, class: 'form-control', checked: params[:with_flag] == '1' %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group text-center">
            <%= f.label :with_sample, 'Is Sample:'  %>
            <%= f.check_box :with_sample, class: 'form-control', checked: params[:with_sample] == '1' %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group text-center">
            <%= f.label :with_has_comments, 'Has Comments:'  %>
            <%= f.check_box :with_has_comments, class: 'form-control', checked: params[:with_has_comments] == '1' %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group text-center">
            <%= f.label :with_has_attachments, 'Has Attachments:'  %>
            <%= f.check_box :with_has_attachments, class: 'form-control', checked: params[:with_has_attachments] == '1' %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group">
            <%= f.label :with_dept, 'Dept:'  %>
            <%= f.select :with_dept, @salt_spray_tests.options_for_dept, {include_blank: true, selected: params[:with_dept]}, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group">
            <%= f.label :with_white_spec, 'White Spec:'  %>
            <%= f.text_field :with_white_spec, class: 'form-control', value: params[:with_white_spec] %>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group">
            <%= f.label :with_red_spec, 'Red Spec:'  %>
            <%= f.text_field :with_red_spec, class: 'form-control', value: params[:with_red_spec] %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <%= f.label :with_comments, 'Comments:'  %>
            <%= f.text_field :with_comments, class: 'form-control', value: params[:with_comments] %>
          </div>
        </div>
      </div>
      <div class="row tab-pane fade" id="dates" role="tabpanel" aria-labelledby="dates-tab">
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_put_on_by, 'Put On By:'  %>
            <%= f.select :with_put_on_by, @salt_spray_tests.options_for_put_on_by, { include_blank: true, selected: params[:with_put_on_by] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_put_on_at_gte, 'Date On - Start:' %>
            <%= f.date_field :with_put_on_at_gte, class: 'form-control', value: params[:with_put_on_at_gte] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_put_on_at_lte, 'Date On - End:' %>
            <%= f.date_field :with_put_on_at_lte, class: 'form-control', value: params[:with_put_on_at_lte] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_white_by, 'Marked White By:'  %>
            <%= f.select :with_marked_white_by, @salt_spray_tests.options_for_marked_white_by, { include_blank: true, selected: params[:with_marked_white_by] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_white_at_gte, 'Date Marked White - Start:' %>
            <%= f.date_field :with_marked_white_at_gte, class: 'form-control', value: params[:with_marked_white_at_gte] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_white_at_lte, 'Date Marked White - End:' %>
            <%= f.date_field :with_marked_white_at_lte, class: 'form-control', value: params[:with_marked_white_at_lte] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_pulled_off_by, 'Pulled Off By:'  %>
            <%= f.select :with_pulled_off_by, @salt_spray_tests.options_for_pulled_off_by, { include_blank: true, selected: params[:with_pulled_off_by] }, { class: 'form-control', disabled: action_name != 'archived_tests' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_pulled_off_at_gte, 'Date Off - Start:' %>
            <%= f.date_field :with_pulled_off_at_gte, class: 'form-control', value: params[:with_pulled_off_at_gte], disabled: action_name != 'archived_tests' %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_pulled_off_at_lte, 'Date Off - End:' %>
            <%= f.date_field :with_pulled_off_at_lte, class: 'form-control', value: params[:with_pulled_off_at_lte], disabled: action_name != 'archived_tests' %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_red_by, 'Marked Red By:'  %>
            <%= f.select :with_marked_red_by, @salt_spray_tests.options_for_marked_red_by, { include_blank: true, selected: params[:with_marked_red_by] }, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_red_at_gte, 'Date Marked Red - Start:' %>
            <%= f.date_field :with_marked_red_at_gte, class: 'form-control', value: params[:with_marked_red_at_gte] %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_marked_red_at_lte, 'Date Marked Red - End:' %>
            <%= f.date_field :with_marked_red_at_lte, class: 'form-control', value: params[:with_marked_red_at_lte] %>
          </div>
        </div>
      </div>
      <div class="row tab-pane fade" id="process-steps" role="tabpanel" aria-labelledby="process-steps-tab">
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_chromate, 'Chromate:'  %>
            <%= f.select :with_chromate, @salt_spray_tests.options_for_chromate, {include_blank: true, selected: params[:with_chromate]}, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <%= f.label :with_top_coat, 'Top Coat:'  %>
            <%= f.select :with_top_coat, @salt_spray_tests.options_for_top_coat, {include_blank: true, selected: params[:with_top_coat]}, { class: 'form-control' } %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <%= f.label :with_note, 'Notes:'  %>
            <%= f.text_field :with_note, class: 'form-control', value: params[:with_note] %>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <%= link_to 'Reset Filters', filter_path, class: 'btn btn-sm btn-link float-left' %>
        <%= f.submit 'Filter', name: nil, class: 'float-right' %>
      </div>
    </div>
  <% end %>

  <%= link_to 'Download CSV of Filtered Data', { :format => :csv }, { :class => 'btn btn-sm btn-info' } %>

</div>

<% if @salt_spray_tests.size == 0 -%>

  <p class="text-muted">No salt spray tests found.</p>

<% else -%>

  <table class="table table-bordered">
    <thead>
      <tr class="row m-0">
        <th class="col-2">
          <div class="row">
            <div class="col-6 text-left">
              Shop Order
            </div>
            <div class="col-6 text-muted text-right">
              (Load)
            </div>
          </div>
        </th>
        <th class="col-1">
          Process / Dept
        </th>
        <th class="col-2">
          <div class="row">
            <div class="col-8 text-left">
              Chromate / Top Coat
            </div>
            <div class="col-4 text-muted text-right">
              Notes
            </div>
          </div>
        </th>
        <th class="col-1">Date On</th>
        <% if action_name == 'archived_tests' %>
          <th class="col-1">Date Off</th>
        <% end %>
        <th class="col-2">
          <div class="row">
            <div class="col-6 text-left">
              White Rust
            </div>
            <div class="col-6 text-muted text-right">
              (Spec)
            </div>
          </div>
        </th> <!-- marked_white_at, marked_white_by -->
        <th class="col-2">
          <div class="row">
            <div class="col-6 text-left">
              Red Rust
            </div>
            <div class="col-6 text-muted text-right">
              (Spec)
            </div>
          </div>
        </th> <!-- marked_red_at, marked_red_by -->
        <th class="col-1 ipad-padding">Comments</th>
        <th class="col-1 text-center hidden-print<%= ' d-none' if action_name == 'archived_tests' %>"></th>
      </tr>
    </thead>
    <tbody>
      <% @salt_spray_tests.each do |t| -%>
        <tr class="row m-0<%= ' bg-warning-table' if t.flagged_by && action_name != 'archived_tests' %>">
          <td class="col-2 text-center shop-order">
            <div class="row">
              <div class="col-9 text-left">
                <strong>
                  <%= '<i class="fa fa-flag text-info" title="This test is flagged"></i> '.html_safe if t.flagged_by %>
                  <%= '<i class="fa fa-flask text-info" title="This is a sample test"></i> '.html_safe if t.is_sample %>
                  <%= t.shop_order_number %><%= " - #{t.sample_code}" if t.sample_code.present? %><br />
                  <small class="text-muted"><%= t.customer %> <%= "&bull; #{t.part_number}".html_safe if t.part_number.present? %> <%= "&bull; #{t.sub}".html_safe if t.sub.present? %></small>
                </strong>
              </div>
              <div class="col-3 text-right text-muted">
                <%= "(#{t.load_number})" if t.load_number %>
              </div>
            </div>
          </td>
          <td class="col-1 process">
            <%= t.process_code %><% if t.dept %> / <%= t.dept %><br /><% end %>
          </td>
          <td class="col-2">
            <div class="row process-steps">
              <% t.salt_spray_process_steps.each_with_index do |step, index| %>
                <div class="col-6 text-left mb-2">
                  <%= step.chromate %> <%= " / #{step.top_coat}" if step.top_coat.present? %>
                </div>
                <div class="col-6 text-right text-muted">
                    <%= step.note %>
                </div>
              <% end %>
            </div>
          </td>
          <td class="col-1">
            <%= t.put_on_at.strftime('%m/%d/%Y') %><br />
            <small><strong>By: </strong></small><%= t.salt_spray_tester.initials %><br />
            <small><strong>Hours On: </strong></small><%= t.calculate_rust_hours(t.pulled_off_at) %>
          </td>
          <% if t.pulled_off_at.present? %>
            <td class="col-1">
              <%= t.pulled_off_at.strftime('%m/%d/%Y') %><br />
              <small><strong>By: </strong></small><%= t.test_completed_by.full_name %>
            </td>
          <% end %>
          <td class="col-2">
            <div class="row">
              <div class="col-9 text-left">
                <% if t.marked_white? %>
                  <%= t.marked_white_at.strftime('%m/%d/%Y') %><br />
                  <small><strong>By: </strong></small><%= t.white_spot_reporter.full_name %><br />
                  <small><strong>Hours to White: </strong></small><%= t.calculate_rust_hours(t.marked_white_at) %> <%= t.get_pass_fail('white') %>
                <% end %>
              </div>
              <div class="col-3 text-muted text-right pl-0">
                <% if t.white_spec_exists? %>
                  <%= "(#{t.white_spec})"  %>
                  <%= t.get_pass_fail('white', true) if !t.marked_white_at %>
                <% end %>
              </div>
            </div>
          </td>
          <td class="col-2">
            <div class="row">
              <div class="col-7 text-left">
                <% if t.marked_red? %>
                  <%= t.marked_red_at.strftime('%m/%d/%Y') %><br />
                  <small><strong>By: </strong></small><%= t.red_spot_reporter.full_name %><br />
                  <small><strong>Hours to Red: </strong></small><%= t.calculate_rust_hours(t.marked_red_at) %> <%= t.get_pass_fail('red') %>
                <% end %>
              </div>
              <div class="col-5 text-muted text-right pl-0">
                <% if t.red_spec_exists? %>
                  <%= "(#{t.red_spec})" %>
                  <%= t.get_pass_fail('red', true) if !t.marked_red_at %>
                <% end %>
              </div>
            </div>
          </td>
          <td class="col-1">
            <%= link_to "View", show_comments_salt_spray_test_path(t.id, on_archived: action_name == 'archived_tests'), remote: true, class: 'btn btn-sm btn-info mr-2' if has_comments(t) %>
            <%= link_to 'Add', add_comment_salt_spray_test_path(t, on_archived: action_name == 'archived_tests'), class: 'btn btn-sm btn-success' %>
            <%= link_to "Edit test", edit_salt_spray_test_path(t.id, on_archived: action_name == 'archived_tests'), class: 'btn btn-sm mr-2' if action_name == 'archived_tests' %>
          </td>
          <% if action_name != 'archived_tests' %>
            <% if @access_level.access_level == 3 -%>
              <td class="col-md-1 text-center hidden-print ipad-padding">
                <a href="#" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Actions</a>
                <div class="dropdown-menu text-center">
                  <%= link_to 'Edit', edit_salt_spray_test_path(t), class: "dropdown-item text-info" if action_name != 'archived_tests' %>
                  <% if t.flagged_by %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :flagged_by, value: nil %>
                      <%= f.submit 'Remove Flag', class: 'btn-form dropdown-item text-warning' %>
                    <% end %>
                  <% end %>
                  <%#= link_to 'View Details', salt_spray_test_path(t), class: "dropdown-item text-muted", remote: true %>
                  <div class="dropdown-divider"></div>
                  <% if !t.marked_white_at && !t.marked_red_at %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :marked_white_at, value: DateTime.current.change(hour: 12, min: 0, sec: 0) %>
                      <%= f.hidden_field :marked_white_by, value: current_user.id %>
                      <% if !t.red_spec_exists? %>
                        <%= button_tag 'Mark White', type: 'button', data: {toggle: 'modal', target: '#test-complete-modal', spot: 'white'}, class: 'btn-form dropdown-item open-submit-modal' %>
                        <%= f.submit 'Mark White', class: 'btn-form dropdown-item test-complete-white d-none' %>
                      <% else %>
                        <%= f.submit 'Mark White', class: 'btn-form dropdown-item' %>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if !t.marked_red_at %>
                    <%= form_with model: t, local: true do |f| %>
                      <%= f.hidden_field :marked_red_at, value: DateTime.current.change(hour: 12, min: 0, sec: 0) %>
                      <%= f.hidden_field :marked_red_by, value: current_user.id %>
                      <%= button_tag 'Mark Red', type: 'button', data: {toggle: 'modal', target: '#test-complete-modal', spot: 'red'}, class: 'btn-form dropdown-item open-submit-modal' %>
                      <%= f.submit 'Mark Red', class: 'btn-form dropdown-item test-complete-red d-none' %>
                    <% end %>
                  <% end %>
                  <%= form_with model: t, local: true do |f| %>
                    <%= f.hidden_field :pulled_off_at, value: DateTime.current.change(hour: 12, min: 0, sec: 0) %>
                    <%= f.hidden_field :pulled_off_by, value: current_user.id %>
                    <%= f.submit 'Mark Complete', class: 'btn-form dropdown-item', data: {confirm: t.ready_to_archive? ? nil : 'Are you sure?'} %>
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <%= link_to 'Delete', salt_spray_test_path(t), data: { confirm: 'Are you sure?'}, method: 'delete', class: 'text-danger dropdown-item' %>
                </div><br>
              </td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

<% end %>

<!-- Modal -->
<div id="test-complete-modal" class="modal fade" role="dialog">
  <div class="vertical-alignment-helper">
    <div class="modal-dialog vertical-align-center">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-body">
          <div id="test-complete-question">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4>Is this test complete?</h4><br /><br />
            <div class="row">
              <div class="col-6">
                <%= button_tag 'No', type: 'button', name: 'no', class: 'btn btn-default test-complete-confirm' %>
              </div>
              <div class="col-6">
                <%= button_tag 'Yes', type: 'button', name: 'yes', class: 'btn btn-success test-complete-confirm' %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>